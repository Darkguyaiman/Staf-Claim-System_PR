<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claims & Allowance Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --color-primary: #2D0C31;
            --color-secondary: #004D4D;
            --color-accent: #00B894;
            --color-light: #B8B5FF;
            --color-lighter: #B8FFB5;
            
            --color-text: #333;
            --color-text-light: #555;
            --color-text-lighter: #777;
            --color-background: #f5f5f5;
            --color-white: #ffffff;
            --color-success: #28a745;
            --color-warning: #ffc107;
            --color-danger: #dc3545;
        }

        html {
          overflow-y: scroll;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--color-light) 0%, var(--color-lighter) 100%);
            color: var(--color-text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            color: #2D0C31;
            padding: 30px 0;
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: var(--color-text-lighter);
        }

        .loading i {
            font-size: 2em;
            color: var(--color-accent);
            margin-bottom: 15px;
            animation: spin 1s infinite linear;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background-color: #fee;
            border: 1px solid #fcc;
            color: var(--color-danger);
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            display: flex;
            align-items: center;
        }

        .error i {
            font-size: 1.5em;
            margin-right: 10px;
            color: var(--color-danger);
        }

        .claims-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .claim-card {
            background: var(--color-white);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border-left: 4px solid var(--color-accent);
            position: relative;
            overflow: hidden;
        }

        .claim-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 30px;
            height: 30px;
            background: var(--color-accent);
            clip-path: polygon(100% 0, 0 0, 100% 100%);
            opacity: 0.3;
        }

        .claim-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .claim-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding-bottom: 10px;
        }

        .application-number {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--color-primary);
            display: flex;
            align-items: center;
        }

        .application-number i {
            margin-right: 8px;
            color: var(--color-accent);
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
            display: flex;
            align-items: center;
        }

        .status i {
            margin-right: 5px;
        }

        .status.approved {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--color-success);
        }

        .status.pending, .status.submitted, .status.in-review {
            background-color: rgba(255, 193, 7, 0.2);
            color: var(--color-warning);
        }

        .status.rejected, .status.canceled {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--color-danger);
        }

        .claim-info {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .claim-info i {
            width: 20px;
            margin-right: 8px;
            color: var(--color-secondary);
            text-align: center;
        }

        .claim-info strong {
            color: var(--color-text-light);
            display: inline-block;
            width: 120px;
            margin-right: 5px;
        }

        .total-amount {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--color-accent);
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(0, 184, 148, 0.1);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .total-amount i {
            margin-right: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background-color: var(--color-white);
            margin: 2% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: var(--color-white);
            padding: 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            display: flex;
            align-items: center;
        }

        .modal-header h2 i {
            margin-right: 10px;
        }

        .close {
            color: var(--color-white);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 20px;
        }

        .detail-section {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--color-accent);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .detail-section h3 {
            color: var(--color-secondary);
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
        }

        .detail-section h3 i {
            margin-right: 10px;
            color: var(--color-accent);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .detail-item {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
        }

        .detail-item i {
            width: 20px;
            margin-right: 8px;
            color: var(--color-secondary);
            text-align: center;
            margin-top: 2px;
        }

        .detail-item strong {
            color: var(--color-text-light);
            display: inline-block;
            width: 150px;
            margin-right: 10px;
        }

        .sub-item {
            background: var(--color-white);
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 3px solid var(--color-accent);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .no-data {
            color: var(--color-text-lighter);
            font-style: italic;
            display: flex;
            align-items: center;
        }

        .no-data i {
            margin-right: 8px;
        }

        .view-receipt-btn {
            display: inline-flex;
            align-items: center;
            background-color: var(--color-accent);
            color: var(--color-white);
            padding: 5px 10px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.8em;
            margin-left: 10px;
            transition: background-color 0.2s;
        }

        .view-receipt-btn i {
            margin-right: 5px;
            color: var(--color-white);
        }

        .view-receipt-btn:hover {
            background-color: var(--color-secondary);
        }

        .status-selector {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--color-accent);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .status-selector h3 {
            color: var(--color-secondary);
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
        }

        .status-selector h3 i {
            margin-right: 10px;
            color: var(--color-accent);
        }

        .status-selector select {
            padding: 10px 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: var(--color-white);
            font-size: 1em;
            width: 100%;
            max-width: 300px;
            margin-bottom: 15px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
        }

        .status-selector select:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.2);
        }

        .status-selector textarea {
            width: 100%;
            padding: 10px 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: var(--color-white);
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 15px;
        }

        .status-selector textarea:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.2);
        }

        .save-status-btn {
            background-color: var(--color-accent);
            color: var(--color-white);
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }

        .save-status-btn i {
            margin-right: 8px;
        }

        .save-status-btn:hover {
            background-color: var(--color-secondary);
        }

        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
            align-items: center;
        }

        .status-message i {
            margin-right: 8px;
        }

        .status-message.success {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--color-success);
        }

        .status-message.error {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--color-danger);
        }

        .allowance-container {
            background: var(--color-white);
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .allowance-type-header {
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-secondary) 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .allowance-type-header i {
            margin-right: 8px;
        }

        .daily-breakdown {
            margin-bottom: 15px;
        }

        .daily-item {
            background: #f8f9fa;
            border-left: 4px solid var(--color-accent);
            padding: 12px;
            margin: 8px 0;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .daily-item-header {
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .daily-item-header i {
            margin-right: 6px;
            color: var(--color-accent);
        }

        .daily-item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            font-size: 0.9em;
        }

        .daily-detail {
            display: flex;
            align-items: center;
        }

        .daily-detail i {
            width: 16px;
            margin-right: 6px;
            color: var(--color-secondary);
        }

        .daily-detail strong {
            margin-right: 5px;
            color: var(--color-text-light);
        }

        .allowance-total {
            background: linear-gradient(135deg, rgba(0, 184, 148, 0.1) 0%, rgba(0, 77, 77, 0.1) 100%);
            border: 2px solid var(--color-accent);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            font-weight: 700;
            font-size: 1.1em;
            color: var(--color-accent);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .allowance-total i {
            margin-right: 8px;
            font-size: 1.2em;
        }

        .simple-calculation {
            text-align: center;
            padding: 20px;
            color: var(--color-text-light);
            font-style: italic;
        }

        .simple-calculation i {
            font-size: 2em;
            color: var(--color-accent);
            margin-bottom: 10px;
            display: block;
        }

        .per-day-calculation {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
        }

        .per-day-calculation i {
            color: var(--color-accent);
            margin-right: 8px;
        }

        .sidebar {
          width: 250px;
          height: 100vh;
          position: fixed;
          left: 0;
          top: 0;
          background-color: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          border-right: 1px solid rgba(45, 12, 49, 0.2);
          box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
          z-index: 100;
          transition: all 0.3s ease;
          overflow-y: auto;
          scrollbar-width: none;
          -ms-overflow-style: none;
        }

        .sidebar::-webkit-scrollbar {
          width: 0;
          height: 0;
          display: none;
        }

        .sidebar.collapsed {
          width: 60px;
        }

        .sidebar-header {
          padding: 20px;
          display: flex;
          flex-direction: column;
          align-items: center;
          border-bottom: 1px solid rgba(45, 12, 49, 0.2);
        }

        .sidebar-logo {
          font-size: 36px;
          color: var(--color-primary);
          margin-bottom: 10px;
          transition: all 0.3s ease;
        }

        .sidebar-title {
          font-size: 20px;
          font-weight: 600;
          color: var(--color-secondary);
          transition: all 0.3s ease;
          white-space: nowrap;
          overflow: hidden;
          text-align: center;
        }

        .sidebar.collapsed .sidebar-logo {
          font-size: 24px;
          margin-bottom: 0;
        }

        .sidebar.collapsed .sidebar-title {
          opacity: 0;
          width: 0;
          height: 0;
          margin: 0;
        }

        .sidebar-nav {
          display: flex;
          flex-direction: column;
          padding: 15px 0;
        }

        .sidebar-item {
          display: flex;
          align-items: center;
          padding: 15px 20px;
          color: var(--color-primary);
          transition: all 0.2s ease;
          border-left: 3px solid transparent;
          white-space: nowrap;
          overflow: hidden;
          text-decoration: none;
          font-size: 16px;
        }

        .sidebar.collapsed .sidebar-item {
          padding: 15px;
          justify-content: center;
        }

        .sidebar-item:hover {
          background-color: rgba(45, 12, 49, 0.1);
          border-left-color: var(--color-primary);
        }

        .sidebar-item.active {
          background-color: rgba(45, 12, 49, 0.15);
          border-left-color: var(--color-primary);
          font-weight: 600;
        }

        .sidebar-item i {
          min-width: 24px;
          font-size: 20px;
          margin-right: 15px;
        }

        .sidebar-item span {
          transition: opacity 0.2s ease;
          font-size: 16px;
        }

        .sidebar.collapsed .sidebar-item span {
          opacity: 0;
          width: 0;
          margin-left: 0;
        }

        .sidebar-toggle {
          position: fixed;
          top: 10px;
          left: 260px;
          width: 40px;
          height: 40px;
          background-color: var(--color-primary);
          color: white;
          border: none;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
          z-index: 101;
          transition: left 0.3s ease;
        }

        .sidebar-toggle i {
          font-size: 24px;
          transition: transform 0.3s ease;
        }

        .sidebar.collapsed + .sidebar-toggle {
          left: 70px;
        }

        .sidebar.collapsed .sidebar-toggle i {
          transform: rotate(180deg);
        }

        .mobile-sidebar-toggle {
          display: none;
          position: fixed;
          top: 10px;
          left: 10px;
          width: 40px;
          height: 40px;
          background-color: var(--color-primary);
          color: white;
          border: none;
          border-radius: 50%;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
          z-index: 1000;
          font-size: 24px;
        }

        .main-content {
          margin-left: 250px;
          transition: all 0.3s ease;
          min-height: 100vh;
          width: calc(100% - 250px);
        }

        .main-content.expanded {
          margin-left: 60px;
          width: calc(100% - 60px);
        }

        .report-button {
            position: fixed;
            top: 70px;
            right: 20px;
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-secondary) 100%);
            color: var(--color-white);
            border: none;
            padding: 15px 20px;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.3);
            transition: all 0.3s ease;
            z-index: 200;
            display: flex;
            align-items: center;
        }

        .report-button i {
            margin-right: 8px;
            font-size: 1.2em;
        }

        .report-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 184, 148, 0.4);
        }

        .report-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            background: #ccc;
            box-shadow: none;
        }

        .report-modal-content {
            background-color: var(--color-white);
            margin: 1% auto;
            padding: 0;
            border-radius: 10px;
            width: 95%;
            max-width: 1000px;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: modalFadeIn 0.3s;
        }

        .report-form {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: var(--color-text-light);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .form-group label i {
            margin-right: 8px;
            color: var(--color-accent);
        }

        .form-group input,
        .form-group select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            background-color: var(--color-white);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.2);
        }

        .user-selection {
            grid-column: 1 / -1;
        }

        /* New styles for searchable dropdown with chips */
        .user-selector-container {
            position: relative;
        }

        .user-search-input {
            width: 100%;
            padding: 10px 40px 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            background-color: var(--color-white);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .user-search-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.2);
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-lighter);
            pointer-events: none;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--color-white);
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .user-dropdown.show {
            display: block;
        }

        .user-dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }

        .user-dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .user-dropdown-item.selected {
            background-color: rgba(0, 184, 148, 0.1);
            color: var(--color-accent);
        }

        .user-dropdown-item i {
            margin-right: 8px;
            color: var(--color-accent);
        }

        .select-all-item {
            border-bottom: 1px solid #eee;
            font-weight: 600;
        }

        .selected-users-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            min-height: 20px;
        }

        .user-chip {
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-secondary) 100%);
            color: var(--color-white);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            animation: chipFadeIn 0.2s ease;
        }

        @keyframes chipFadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .user-chip .remove-chip {
            margin-left: 8px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .user-chip .remove-chip:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .generate-btn {
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-secondary) 100%);
            color: var(--color-white);
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px auto 0;
        }

        .generate-btn i {
            margin-right: 8px;
        }

        .generate-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 184, 148, 0.3);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .report-results {
            padding: 20px;
            display: none;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--color-accent);
        }

        .report-title {
            color: var(--color-primary);
            font-size: 1.3em;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .report-title i {
            margin-right: 8px;
            color: var(--color-accent);
        }

        .export-btn {
            background-color: var(--color-secondary);
            color: var(--color-white);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
            font-size: 0.9em;
        }

        .export-btn i {
            margin-right: 6px;
        }

        .export-btn:hover {
            background-color: var(--color-primary);
        }

        .user-report {
            margin-bottom: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }

        .user-report-header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: var(--color-white);
            padding: 12px 16px;
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .user-report-header i {
            margin-right: 8px;
        }

        .user-report-content {
            padding: 16px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: #f8f9fa;
            border-left: 4px solid var(--color-accent);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }

        .summary-card i {
            font-size: 1.5em;
            color: var(--color-accent);
            margin-bottom: 8px;
            display: block;
        }

        .summary-card .value {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--color-primary);
            margin-bottom: 4px;
        }

        .summary-card .label {
            color: var(--color-text-light);
            font-size: 0.85em;
        }

        .breakdown-section {
            margin-bottom: 20px;
        }

        .breakdown-title {
            color: var(--color-secondary);
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .breakdown-title i {
            margin-right: 6px;
            color: var(--color-accent);
        }

        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
        }

        .breakdown-item {
            background: var(--color-white);
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .breakdown-item .amount {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--color-accent);
            margin-bottom: 4px;
        }

        .breakdown-item .type {
            color: var(--color-text-light);
            font-size: 0.8em;
        }

        .location-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .location-stat {
            background: linear-gradient(135deg, rgba(0, 184, 148, 0.1) 0%, rgba(0, 77, 77, 0.1) 100%);
            border: 1px solid var(--color-accent);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        .location-stat .count {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--color-accent);
            margin-bottom: 4px;
        }

        .location-stat .location {
            color: var(--color-text-light);
            font-weight: 600;
            font-size: 0.85em;
        }

        .no-report-data {
            text-align: center;
            color: var(--color-text-lighter);
            font-style: italic;
            padding: 30px;
        }

        .no-report-data i {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
            color: var(--color-accent);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .claims-grid {
                grid-template-columns: 1fr;
            }

            .modal-content, .report-modal-content {
                width: 95%;
                margin: 5% auto;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .detail-item strong {
                width: 100%;
                display: block;
                margin-bottom: 2px;
            }

            .daily-item-details {
                grid-template-columns: 1fr;
            }

            .report-button {
                top: 60px;
                right: 10px;
                padding: 12px 16px;
                font-size: 0.9em;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }

            .breakdown-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }

            .location-stats {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }

          .sidebar {
            transform: translateX(-100%);
            width: 80%;
            max-width: 300px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
          }
          
          .sidebar.open {
            transform: translateX(0);
          }
          
          .sidebar.collapsed {
            transform: translateX(-100%);
            width: 80%;
          }
          
          .main-content {
            margin-left: 0;
            width: 100%;
            padding-top: 60px;
          }
          
          .main-content.expanded {
            margin-left: 0;
            width: 100%;
          }
          
          .sidebar-toggle {
            display: none;
          }
          
          .mobile-sidebar-toggle {
            display: flex;
          }
          
          .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 99;
          }
          
          .sidebar-overlay.active {
            display: block;
          }
        }

        #filterBar input:focus, 
        #filterBar select:focus {
          border-color: var(--color-accent);
          box-shadow: 0 0 0 2px rgba(0, 184, 148, 0.2);
        }

        ::-webkit-scrollbar {
          width: 12px;
        }

        ::-webkit-scrollbar-track {
          background: var(--color-lighter);
        }

        ::-webkit-scrollbar-thumb {
          background-color: var(--color-primary);
          border-radius: 10px;
          border: 2px solid var(--color-lighter);
        }

        ::-webkit-scrollbar-thumb:hover {
          background-color: var(--color-secondary);
        }

        * {
          scrollbar-width: thin;
          scrollbar-color: var(--color-primary) var(--color-lighter);
        }
    </style>
</head>
<body>
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-logo">
      <i class="fas fa-chart-bar"></i>
    </div>
    <h2 class="sidebar-title">Claim System</h2>
  </div>
  <div class="sidebar-menu">
    <a href="YOUR_DASHBOARD_DEPLOYMENT_LINK" target="_top" class="sidebar-item">
      <i class="fas fa-tachometer-alt"></i>
      <span>Dashboard</span>
    </a>
    <a href="YOUR_EVENT_PANEL_DEPLOYMENT_LINK" target="_top" class="sidebar-item">
      <i class="fas fa-calendar-alt"></i>
      <span>Event Panel</span>
    </a>
    <a href="YOUR_CLAIMS_PANEL_DEPLOYMENT_LINK" target="_top" class="sidebar-item">
      <i class="fas fa-hand-holding-usd"></i>
      <span>Claims & Allowance Panel</span>
    </a>
    <a href="YOUR_BUDGET_PANEL_DEPLOYMENT_LINK" target="_top" class="sidebar-item">
      <i class="fas fa-dollar-sign"></i>
      <span>Budget & Expenses Panel</span>
    </a>
    <a href="YOUR_ADVANCE_PURCHASE_PANEL_DEPLOYMENT_LINK" target="_top" class="sidebar-item active">
      <i class="fas fa-shopping-cart"></i>
      <span>Advance Purchases Panel</span>
    </a>
    <a href="YOUR_PETTY_CASH_PANEL_DEPLOYMENT_LINK" target="_top" class="sidebar-item">
      <i class="fas fa-wallet"></i>
      <span>Petty Cash Panel</span>
    </a>
    <a href="YOUR_SETTINGS_DEPLOYMENT_LINK" target="_top" class="sidebar-item">
      <i class="fas fa-cog"></i>
      <span>Settings</span>
    </a>
  </div>
</aside>

<button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
  <i class="fas fa-bars"></i>
</button>

<button class="mobile-sidebar-toggle" id="mobileSidebarToggle" aria-label="Toggle mobile sidebar">
  <i class="fas fa-bars"></i>
</button>

<button class="report-button" id="reportButton" onclick="openReportModal()" disabled>
    <i class="fas fa-chart-line"></i>Generate Report
</button>

<main class="main-content" id="mainContent">
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-file-invoice-dollar"></i> <strong> Claims & Allowance Management </strong></h1>
        </div>

        <div id="loading" class="loading">
            <i class="fas fa-spinner"></i>
            <div>Loading claims data...</div>
        </div>

        <div id="error" class="error" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorText"></span>
        </div>
        <div id="filterBar" style="
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid var(--color-accent);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        ">
          <div style="position: relative; flex: 2;">
            <i class="fas fa-search" style="
                position: absolute;
                top: 50%;
                left: 12px;
                transform: translateY(-50%);
                color: var(--color-secondary);
                font-size: 1em;
            "></i>
            <input id="searchInput" type="text" placeholder="Search by Application #"
              style="width: 100%; padding: 12px 15px 12px 38px; border: 1px solid #ccc;
                    border-radius: 6px; font-size: 1em; outline: none;" />
          </div>

          <div style="position: relative; flex: 1;">
            <i class="fas fa-tasks" style="
                position: absolute;
                top: 50%;
                left: 12px;
                transform: translateY(-50%);
                color: var(--color-secondary);
                font-size: 1em;
            "></i>
            <select id="statusFilter" style="
                width: 100%; padding: 12px 15px 12px 38px;
                border-radius: 6px;
                border: 1px solid #ccc;
                font-size: 1em;
                background-color: white;
                color: var(--color-text);
            ">
              <option value="">All Statuses</option>
              <option value="Submitted">Submitted</option>
              <option value="In Review">In Review</option>
              <option value="Approved">Approved</option>
              <option value="Rejected">Rejected</option>
              <option value="Canceled">Canceled</option>
            </select>
          </div>

          <div style="position: relative; flex: 1;">
            <i class="fas fa-user" style="
                position: absolute;
                top: 50%;
                left: 12px;
                transform: translateY(-50%);
                color: var(--color-secondary);
                font-size: 1em;
            "></i>
            <select id="personFilter" style="
                width: 100%; padding: 12px 15px 12px 38px;
                border-radius: 6px;
                border: 1px solid #ccc;
                font-size: 1em;
                background-color: white;
                color: var(--color-text);
            ">
              <option value="">All Submitters</option>
            </select>
          </div>
        </div>
        <div id="claimsContainer" class="claims-grid" style="display: none;"></div>
    </div>

    <div id="claimModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-file-alt"></i> <span id="modalTitle">Claim Details</span></h2>
                <button class="close" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="report-modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-chart-line"></i>User Claims & Allowance Report Generator</h2>
                <button class="close" onclick="closeReportModal()"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="report-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="reportStartDate">
                            <i class="fas fa-calendar-alt"></i>Start Date
                        </label>
                        <input type="date" id="reportStartDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportEndDate">
                            <i class="fas fa-calendar-alt"></i>End Date
                        </label>
                        <input type="date" id="reportEndDate" required>
                    </div>
                </div>

                <div class="form-group user-selection">
                    <label>
                        <i class="fas fa-users"></i>Select Users for Report
                    </label>
                    <div class="user-selector-container">
                        <input type="text" id="userSearchInput" class="user-search-input" placeholder="Search and select users..." autocomplete="off">
                        <i class="fas fa-search search-icon"></i>
                        <div class="user-dropdown" id="userDropdown"></div>
                    </div>
                    <div class="selected-users-chips" id="selectedUsersChips"></div>
                </div>

                <button class="generate-btn" id="generateReportBtn" onclick="generateReport()">
                    <i class="fas fa-chart-bar"></i>Generate User Report
                </button>
            </div>

            <div class="report-results" id="reportResults">
                <div class="report-header">
                    <div class="report-title">
                        <i class="fas fa-file-alt"></i>Claims Report
                    </div>
                    <button class="export-btn" onclick="exportReportPDF()">
                        <i class="fas fa-download"></i>Download Report
                    </button>
                </div>
                <div id="reportContent">
                </div>
            </div>
        </div>
    </div>
</main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script>
        let allClaims = [];
        let currentClaimNumber = null;
        let reportData = [];
        let allUsers = [];
        let selectedUsers = new Set();

        window.onload = function() {
            loadClaims();
        };

        document.addEventListener('DOMContentLoaded', function() {
          const sidebar = document.getElementById('sidebar');
          const mainContent = document.getElementById('mainContent');
          const sidebarToggle = document.getElementById('sidebarToggle');
          const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
          
          const overlay = document.createElement('div');
          overlay.className = 'sidebar-overlay';
          document.body.appendChild(overlay);
          
          const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
          if (sidebarCollapsed && window.innerWidth > 768) {
            sidebar.classList.add('collapsed');
            mainContent.classList.add('expanded');
          }
          
          function toggleSidebar(event) {
            if (event) event.stopPropagation();
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
          }
          
          function toggleMobileSidebar(event) {
            if (event) event.stopPropagation();
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
          }
          
          if (sidebarToggle) {
            sidebarToggle.addEventListener('click', toggleSidebar);
          }
          
          if (mobileSidebarToggle) {
            mobileSidebarToggle.addEventListener('click', toggleMobileSidebar);
          }
          
          overlay.addEventListener('click', function() {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
          });
          
          document.addEventListener('click', function(event) {
            if (window.innerWidth <= 768 && 
                !sidebar.contains(event.target) && 
                event.target !== mobileSidebarToggle &&
                !mobileSidebarToggle.contains(event.target)) {
              sidebar.classList.remove('open');
              overlay.classList.remove('active');
            }
          });
          
          window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
              sidebar.classList.remove('open');
              overlay.classList.remove('active');
              
              if (localStorage.getItem('sidebarCollapsed') === 'true') {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('expanded');
              } else {
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('expanded');
              }
            } else {
              sidebar.classList.remove('collapsed');
              mainContent.classList.remove('expanded');
            }
          });
          
          const currentPath = window.location.pathname;
          const sidebarItems = document.querySelectorAll('.sidebar-item');
          
          sidebarItems.forEach(item => {
            const itemPath = item.getAttribute('href');
            if (itemPath && (currentPath.includes(itemPath) || 
                (currentPath === '/' && itemPath === '#'))) {
              item.classList.add('active');
            }
          });

          initializeUserSelector();
        });

        function loadClaims() {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading').style.flexDirection = 'column';
            document.getElementById('error').style.display = 'none';
            document.getElementById('claimsContainer').style.display = 'none';

            const reportButton = document.getElementById('reportButton');
            reportButton.disabled = true;

            google.script.run
                .withSuccessHandler(onClaimsLoaded)
                .withFailureHandler(onError)
                .getAllClaims();
        }

        function onClaimsLoaded(claimsJson) {
            let claims;

            try {
                claims = JSON.parse(claimsJson).reverse();
            } catch (e) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('errorText').innerHTML = 'Failed to load claims data.';
                document.getElementById('error').style.display = 'flex';
                console.error("JSON parsing error:", e);
                return;
            }

            allClaims = claims;

            const personSet = new Set(claims.map(c => c.personOfSubmission).filter(Boolean));
            const personFilter = document.getElementById('personFilter');
            personSet.forEach(person => {
                const option = document.createElement('option');
                option.value = person;
                option.textContent = person;
                personFilter.appendChild(option);
            });

            allUsers = Array.from(personSet).sort();

            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('personFilter').addEventListener('change', applyFilters);

            document.getElementById('loading').style.display = 'none';

            const reportButton = document.getElementById('reportButton');
            reportButton.disabled = false;

            if (claims.length === 0) {
                document.getElementById('errorText').innerHTML = 'No claims found.';
                document.getElementById('error').style.display = 'flex';
                return;
            }

            displayClaims(claims);
            document.getElementById('claimsContainer').style.display = 'grid';
        }

        function onError(error) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('errorText').innerHTML = 'Error loading claims: ' + error.message;
            document.getElementById('error').style.display = 'flex';

            const reportButton = document.getElementById('reportButton');
            reportButton.disabled = false;
        }

        function displayClaims(claims) {
            const container = document.getElementById('claimsContainer');
            container.innerHTML = '';

            claims.forEach(claim => {
                const card = createClaimCard(claim);
                container.appendChild(card);
            });
        }

        function applyFilters() {
          const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
          const selectedStatus = document.getElementById('statusFilter').value;
          const selectedPerson = document.getElementById('personFilter').value;

          const filtered = allClaims.filter(claim => {
              const matchesAppNumber = claim.applicationNumber.toLowerCase().includes(searchTerm);
              const matchesStatus = selectedStatus === '' || claim.eventStatus === selectedStatus;
              const matchesPerson = selectedPerson === '' || claim.personOfSubmission === selectedPerson;

              return matchesAppNumber && matchesStatus && matchesPerson;
          });

          displayClaims(filtered);
      }

        function createClaimCard(claim) {
            const card = document.createElement('div');
            card.className = 'claim-card';
            card.onclick = () => showClaimDetails(claim.applicationNumber);

            const statusClass = getStatusClass(claim.eventStatus);
            const statusIcon = getStatusIcon(claim.eventStatus);
            
            card.innerHTML = `
                <div class="claim-header">
                    <div class="application-number">
                        <i class="fas fa-hashtag"></i>${claim.applicationNumber}
                    </div>
                    <div class="status ${statusClass}">
                        <i class="${statusIcon}"></i>${claim.eventStatus}
                    </div>
                </div>
                <div class="claim-info">
                    <i class="fa-solid fa-calendar-day"></i>
                    <strong>Event:</strong> ${claim.eventName || 'N/A'}
                </div>
                <div class="claim-info">
                    <i class="fas fa-user"></i>
                    <strong>Submitted by:</strong> ${claim.personOfSubmission || 'N/A'}
                </div>
                <div class="claim-info">
                    <i class="fas fa-calendar-alt"></i>
                    <strong>Date:</strong> ${formatDate(claim.createdDate)}
                </div>
                <div class="claim-info">
                    <i class="fas fa-map-marker-alt"></i>
                    <strong>Location:</strong> ${claim.locationStatus || 'N/A'}
                </div>
                <div class="claim-info">
                    <i class="fas fa-business-time"></i>
                    <strong>Time on Duty:</strong> ${claim.totalTimeOnDuty ? claim.totalTimeOnDuty.formatted : 'N/A'}
                </div>
                <div class="total-amount">
                    <i class="fas fa-money-bill-wave"></i>
                    Total: RM ${formatCurrency(claim.totalClaim)}
                </div>
            `;

            return card;
        }

        function getStatusClass(status) {
            if (!status) return '';
            const statusLower = status.toLowerCase();
            if (statusLower.includes('approved')) return 'approved';
            if (statusLower.includes('pending') || statusLower.includes('submitted') || statusLower.includes('review')) return 'pending';
            if (statusLower.includes('rejected') || statusLower.includes('canceled')) return 'rejected';
            return '';
        }

        function getStatusIcon(status) {
            if (!status) return 'fas fa-question-circle';
            const statusLower = status.toLowerCase();
            if (statusLower.includes('approved')) return 'fas fa-check-circle';
            if (statusLower.includes('pending')) return 'fas fa-clock';
            if (statusLower.includes('submitted')) return 'fas fa-paper-plane';
            if (statusLower.includes('review')) return 'fas fa-search';
            if (statusLower.includes('rejected')) return 'fas fa-times-circle';
            if (statusLower.includes('canceled')) return 'fas fa-ban';
            return 'fas fa-question-circle';
        }

        function formatDate(date) {
            if (!date) return 'N/A';
            
            let dateObj;
            if (date instanceof Date) {
                dateObj = date;
            } else if (typeof date === 'string') {
                dateObj = new Date(date);
            } else {
                return 'Invalid Date';
            }
            
            if (isNaN(dateObj.getTime())) {
                return 'Invalid Date';
            }
            
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0'); 
            const year = dateObj.getFullYear();
            
            return `${day}/${month}/${year}`;
        }

        function formatCurrency(amount) {
            if (!amount && amount !== 0) return '0.00';
            return parseFloat(amount).toFixed(2);
        }

        function showClaimDetails(applicationNumber) {
            const claim = allClaims.find(c => c.applicationNumber === applicationNumber);
            if (!claim) return;

            currentClaimNumber = applicationNumber;
            document.getElementById('modalTitle').textContent = `Claim Details - #${applicationNumber}`;
            document.getElementById('modalBody').innerHTML = generateClaimDetailsHTML(claim);
            document.getElementById('claimModal').style.display = 'block';
            
            const saveBtn = document.getElementById('saveStatusBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveClaimStatus);
            }
        }

        function formatWorkingType(workingType) {
            if (!workingType) return 'N/A';
            return workingType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function formatFoodProvided(foodProvided) {
            if (!foodProvided) return 'N/A';
            return foodProvided.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function renderAllowance(allowanceData, label) {

            if (!allowanceData || (typeof allowanceData === 'object' && Object.keys(allowanceData).length === 0)) {
                return '';
            }

            let parsedData;

            if (typeof allowanceData === 'object' && typeof allowanceData.label === 'string') {
                const maybeJson = allowanceData.label.trim();
                if (maybeJson.startsWith('{') || maybeJson.startsWith('[')) {
                    try {
                        parsedData = JSON.parse(maybeJson);
                    } catch (e) {
                        console.error('Failed to parse JSON in label field:', e);
                        return '';
                    }
                }
            }

            if (!parsedData) {
                if (typeof allowanceData === 'string') {
                    const trimmed = allowanceData.trim();
                    if (trimmed.startsWith('{') || trimmed.startsWith('[')) {
                        try {
                            parsedData = JSON.parse(trimmed);
                        } catch (e) {
                            console.error('Failed to parse JSON:', e);
                            return '';
                        }
                    } else {
                        if (trimmed.toLowerCase().includes('select') || trimmed === 'N/A') {
                            return '';
                        }
                        return `
                            <div class="allowance-container">
                                <div style="padding: 10px; text-align: center;">
                                    ${escapeHtml(trimmed)}
                                </div>
                            </div>`;
                    }
                } else if (typeof allowanceData === 'object') {
                    parsedData = allowanceData;
                } else {
                    return '';
                }
            }

            if (!parsedData.type) {
                return '';
            }

            const isEmptySimpleCalc =
                parsedData.type === 'Simple calculation' &&
                (!parsedData.totalAmount || parsedData.totalAmount === 0) &&
                (!parsedData.amount || parsedData.amount === 0) &&
                (!Array.isArray(parsedData.dailyBreakdown) || parsedData.dailyBreakdown.length === 0);

            if (isEmptySimpleCalc) {
                return '';
            }

            const total = parsedData.totalAmount || parsedData.amount || 0;
            if (!total || total === 0) {
                return '';
            }

            let html = `<div class="allowance-container">`;

            if (parsedData.type === 'Daily breakdown') {
                if (Array.isArray(parsedData.dailyBreakdown) && parsedData.dailyBreakdown.length > 0) {
                    html += '<div class="daily-breakdown">';
                    parsedData.dailyBreakdown.forEach((day, index) => {
                        html += `
                            <div class="daily-item">
                                <div class="daily-item-header">
                                    <i class="fas fa-calendar-day"></i>
                                    Day ${index + 1}: ${formatDate(day.date)}
                                </div>
                                <div class="daily-item-details">
                                    <div class="daily-detail">
                                        <i class="fas fa-clock"></i>
                                        <strong>Working Type:</strong> ${formatWorkingType(day.workingType)}
                                    </div>
                                    <div class="daily-detail">
                                        <i class="fas fa-utensils"></i>
                                        <strong>Food Provided:</strong> ${formatFoodProvided(day.foodProvided)}
                                    </div>
                                    <div class="daily-detail">
                                        <i class="fas fa-money-bill"></i>
                                        <strong>Amount:</strong> RM ${formatCurrency(day.amount)}
                                    </div>
                                </div>
                            </div>`;
                    });
                    html += '</div>';
                }
            } else if (parsedData.type === 'Per day calculation') {
                if (parsedData.amount && parsedData.amount > 0) {
                    html += `
                        <div class="per-day-calculation">
                            <i class="fas fa-calendar-day"></i>
                            <strong>Per Day Rate:</strong> RM ${formatCurrency(parsedData.amount)}
                        </div>`;
                }
            }

            if (parsedData.totalAmount && parsedData.totalAmount > 0) {
                html += `
                    <div class="allowance-total">
                        <i class="fas fa-money-bill-wave"></i>
                        Total ${label}: RM ${formatCurrency(parsedData.totalAmount)}
                    </div>`;
            } else if (parsedData.amount && parsedData.amount > 0) {
                html += `
                    <div class="allowance-total">
                        <i class="fas fa-money-bill-wave"></i>
                        Total ${label}: RM ${formatCurrency(parsedData.amount)}
                    </div>`;
            }

            html += '</div>';
            return html;
        }

        const escapeHtml = (unsafe) =>
            unsafe.replace(/&/g, "&amp;")
                  .replace(/</g, "&lt;")
                  .replace(/>/g, "&gt;")
                  .replace(/"/g, "&quot;")
                  .replace(/'/g, "&#039;");

        function createReceiptButton(url) {
            if (!url || url === 'N/A') 
                return '<span class="no-data"><i class="fas fa-receipt"></i> No Receipt Available</span>';

            let validUrl = url;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                validUrl = 'https://' + url;
            }

            const safeUrl = escapeHtml(validUrl);
            return `<a href="${safeUrl}" target="_blank" class="view-receipt-btn" onclick="event.stopPropagation();"><i class="fas fa-external-link-alt"></i> View Receipt</a>`;
        }

        function generateClaimDetailsHTML(claim) {
            let html = `
                <div class="detail-section">
                    <h3><i class="fas fa-info-circle"></i> Basic Information</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <i class="fas fa-hashtag"></i>
                            <strong>Application #:</strong> ${claim.applicationNumber}
                        </div>
                        <div class="detail-item">
                            <i class="${getStatusIcon(claim.eventStatus)}"></i>
                            <strong>Status:</strong> ${claim.eventStatus || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-calendar-alt"></i>
                            <strong>Created Date:</strong> ${formatDate(claim.createdDate)}
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-user"></i>
                            <strong>Person:</strong> ${claim.personOfSubmission || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <i class="fa-solid fa-calendar-day"></i>
                            <strong>Event Name:</strong> ${claim.eventName || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <strong>Location Status:</strong> ${claim.locationStatus || 'N/A'}
                        </div>
                        <div class="detail-item" style="flex-direction: column; align-items: flex-start;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <i class="fas fa-clock" style="margin-right: 8px;"></i>
                                <strong>Time Slots:</strong>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                ${(claim.timeSlot || '')
                                    .split(',')
                                    .map(slot => `<span style="
                                        background-color: var(--color-accent);
                                        color: white;
                                        padding: 5px 12px;
                                        border-radius: 20px;
                                        font-size: 0.85em;
                                        margin: 2px;
                                        white-space: nowrap;
                                    ">${slot.trim()}</span>`).join('')}
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-business-time"></i>
                            <strong>Time on Duty:</strong> ${claim.totalTimeOnDuty ? claim.totalTimeOnDuty.formatted : 'N/A'}
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-id-card"></i>
                            <strong>Event ID:</strong> ${claim.eventId || 'N/A'}
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-comment"></i>
                            <strong>Remarks:</strong> ${claim.remarks || 'N/A'}
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3><i class="fas fa-money-check-alt"></i> Financial Details</h3>
                    <div class="detail-grid" style="grid-template-columns: 1fr;">
                        <div class="detail-item" style="flex-direction: column; align-items: flex-start;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <i class="fas fa-utensils"></i>
                                <strong>Meal Allowance:</strong>
                            </div>
                            ${renderAllowance(claim.mealAllowance, 'Meal Allowance')}
                        </div>
                        <div class="detail-item" style="flex-direction: column; align-items: flex-start;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <i class="fas fa-plus-circle"></i>
                                <strong>Other Allowances:</strong>
                            </div>
                            ${renderAllowance(claim.otherAllowances, 'Other Allowance')}
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-money-bill-wave"></i>
                            <strong>Total Claim:</strong> RM ${formatCurrency(claim.totalClaim)}
                        </div>
                    </div>
                </div>
            `;

            if (claim.stays && claim.stays.length > 0) {
                html += `
                    <div class="detail-section">
                        <h3><i class="fas fa-hotel"></i> Stay Information</h3>
                `;
                claim.stays.forEach((stay, i) => {
                    html += `
                        <div class="sub-item">
                            <div class="detail-item">
                                <i class="fas fa-bed"></i>
                                <strong>Stay #${i + 1} Type:</strong> ${stay.stayType || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-tag"></i>
                                <strong>Stay Cost:</strong> RM ${formatCurrency(stay.stayCost)}
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-receipt"></i>
                                <strong>Stay Receipt:</strong> ${createReceiptButton(stay.stayReceipt)}
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            if (claim.extraClaims && claim.extraClaims.length > 0) {
                html += `
                    <div class="detail-section">
                        <h3><i class="fas fa-file-invoice"></i> Extra Claims</h3>
                `;
                claim.extraClaims.forEach((extra, index) => {
                    html += `
                        <div class="sub-item">
                            <div class="detail-item">
                                <i class="fas fa-align-left"></i>
                                <strong>Description:</strong> ${extra.claimDescription || 'N/A'}
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-dollar-sign"></i>
                                <strong>Amount:</strong> RM ${formatCurrency(extra.claimAmount)}
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-receipt"></i>
                                <strong>Receipt:</strong> ${createReceiptButton(extra.claimReceipt)}
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }

            if (claim.transportation && claim.transportation.length > 0) {
                html += `
                    <div class="detail-section">
                        <h3><i class="fas fa-car"></i> Transportation</h3>
                `;
                claim.transportation.forEach((transport, index) => {
                    html += `
                        <div class="sub-item">
                            <div class="detail-item">
                                <i class="fas fa-shuttle-van"></i>
                                <strong>Type:</strong> ${transport.transportationType || 'N/A'}
                            </div>
                    `;
                    
                    if (transport.carType) {
                        html += `
                            <div class="detail-item">
                                <i class="fas fa-car-side"></i>
                                <strong>Car Type:</strong> ${transport.carType}
                            </div>
                        `;
                    }
                    if (transport.companyCar) {
                        html += `
                            <div class="detail-item">
                                <i class="fas fa-building"></i>
                                <strong>Company Car:</strong> ${transport.companyCar}
                            </div>
                        `;
                    }
                    if (transport.distanceTravelled) {
                        html += `
                            <div class="detail-item">
                                <i class="fas fa-route"></i>
                                <strong>Distance:</strong> ${transport.distanceTravelled}
                            </div>
                        `;
                    }
                    if (transport.touchNGoCost) {
                        html += `
                            <div class="detail-item">
                                <i class="fas fa-credit-card"></i>
                                <strong>Touch N Go:</strong> RM ${formatCurrency(transport.touchNGoCost)}
                            </div>
                        `;
                    }
                    if (transport.transportCost) {
                        html += `
                            <div class="detail-item">
                                <i class="fas fa-money-bill"></i>
                                <strong>Transport Cost:</strong> RM ${formatCurrency(transport.transportCost)}
                            </div>
                        `;
                    }
                    if (transport.receipt) {
                        html += `
                            <div class="detail-item">
                                <i class="fas fa-receipt"></i>
                                <strong>Receipt:</strong> ${createReceiptButton(transport.receipt)}
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                });
                html += `</div>`;
            }

            html += `
                <div class="status-selector">
                    <h3><i class="fas fa-edit"></i> Update Status</h3>
                    <select id="statusSelect">
                        <option value="Submitted" ${claim.eventStatus === 'Submitted' ? 'selected' : ''}>Submitted</option>
                        <option value="In Review" ${claim.eventStatus === 'In Review' ? 'selected' : ''}>In Review</option>
                        <option value="Approved" ${claim.eventStatus === 'Approved' ? 'selected' : ''}>Approved</option>
                        <option value="Rejected" ${claim.eventStatus === 'Rejected' ? 'selected' : ''}>Rejected</option>
                        <option value="Canceled" ${claim.eventStatus === 'Canceled' ? 'selected' : ''}>Canceled</option>
                    </select>
                    <label for="operationalNotes" style="display: block; margin-bottom: 5px; font-weight: bold; color: var(--color-text-light);">
                        <i class="fas fa-clipboard" style="margin-right: 8px;"></i>Operational Notes:
                    </label>
                    <textarea id="operationalNotes" placeholder="Write any operational notes regarding this application...">${claim.notesOperations || ''}</textarea>
                    <button id="saveStatusBtn" class="save-status-btn">
                        <i class="fas fa-save"></i> Save Status & Notes
                    </button>
                    <div id="statusMessage" class="status-message"></div>
                </div>
            `;

            return html;
        }

        function saveClaimStatus() {
            if (!currentClaimNumber) return;
            
            const statusSelect = document.getElementById('statusSelect');
            const operationalNotes = document.getElementById('operationalNotes');
            const newStatus = statusSelect.value;
            const newNotes = operationalNotes.value;
            const statusMessage = document.getElementById('statusMessage');
            
            statusMessage.textContent = '';
            statusMessage.className = 'status-message';
            statusMessage.style.display = 'none';
            
            const saveBtn = document.getElementById('saveStatusBtn');
            const originalBtnText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveBtn.disabled = true;
            
            google.script.run
                .withSuccessHandler(function(response) {
                    saveBtn.innerHTML = originalBtnText;
                    saveBtn.disabled = false;
                    
                    if (response.success) {
                        statusMessage.innerHTML = '<i class="fas fa-check-circle"></i> ' + response.message;
                        statusMessage.className = 'status-message success';
                    } else {
                        statusMessage.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + response.message;
                        statusMessage.className = 'status-message error';
                    }
                    statusMessage.style.display = 'flex';
                    
                    if (response.success) {
                        const claimIndex = allClaims.findIndex(c => c.applicationNumber === currentClaimNumber);
                        if (claimIndex !== -1) {
                            allClaims[claimIndex].eventStatus = newStatus;
                            allClaims[claimIndex].notesOperations = newNotes;
                            displayClaims(allClaims);
                        }
                    }
                    
                    setTimeout(function() {
                        statusMessage.style.display = 'none';
                    }, 3000);
                })
                .withFailureHandler(function(error) {
                    saveBtn.innerHTML = originalBtnText;
                    saveBtn.disabled = false;
                    
                    statusMessage.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error: ' + error.message;
                    statusMessage.className = 'status-message error';
                    statusMessage.style.display = 'flex';
                })
                .updateClaimStatusAndNotes(currentClaimNumber, newStatus, newNotes);
        }

        function closeModal() {
            document.getElementById('claimModal').style.display = 'none';
            currentClaimNumber = null;
        }

        function openReportModal() {
            document.getElementById('reportModal').style.display = 'block';
            document.getElementById('reportResults').style.display = 'none';
            resetUserSelector();
        }

        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
        }

        function initializeUserSelector() {
            const searchInput = document.getElementById('userSearchInput');
            const dropdown = document.getElementById('userDropdown');
            
            searchInput.addEventListener('input', handleUserSearch);
            searchInput.addEventListener('focus', showUserDropdown);

            document.addEventListener('click', function(event) {
                if (!event.target.closest('.user-selector-container')) {
                    hideUserDropdown();
                }
            });
        }


        function handleUserSearch() {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            const dropdown = document.getElementById('userDropdown');
            
            if (searchTerm.length === 0) {
                populateUserDropdown(allUsers);
            } else {
                const filteredUsers = allUsers.filter(user => 
                    user.toLowerCase().includes(searchTerm)
                );

                if (filteredUsers.length === 0) {
                    dropdown.innerHTML = '';
                    dropdown.classList.add('show');
                    return;
                }
                
                populateUserDropdown(filteredUsers);
            }
            
            showUserDropdown();
        }

        function populateUserDropdown(users) {
            const dropdown = document.getElementById('userDropdown');
            dropdown.innerHTML = '';

            const selectAllDiv = document.createElement('div');
            selectAllDiv.className = 'user-dropdown-item select-all-item';
            selectAllDiv.innerHTML = `
                <i class="fas fa-check-double"></i>
                <strong>Select All</strong>
            `;
            selectAllDiv.onclick = () => selectAllUsers(users);
            dropdown.appendChild(selectAllDiv);

            users.forEach(user => {
                const div = document.createElement('div');
                div.className = `user-dropdown-item ${selectedUsers.has(user) ? 'selected' : ''}`;
                div.innerHTML = `
                    <i class="fas ${selectedUsers.has(user) ? 'fa-check-circle' : 'fa-user'}"></i>
                    ${user}
                `;
                div.onclick = () => toggleUserSelection(user);
                dropdown.appendChild(div);
            });
        }

        function showUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            if (allUsers.length > 0) {
                populateUserDropdown(allUsers);
                dropdown.classList.add('show');
            }
        }

        function hideUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.remove('show');
        }

        function toggleUserSelection(user) {
            if (selectedUsers.has(user)) {
                selectedUsers.delete(user);
            } else {
                selectedUsers.add(user);
            }
            updateSelectedUsersDisplay();
            updateDropdownSelection();
        }

        function selectAllUsers(users) {
            users.forEach(user => selectedUsers.add(user));
            updateSelectedUsersDisplay();
            updateDropdownSelection();
        }

        function updateSelectedUsersDisplay() {
            const chipsContainer = document.getElementById('selectedUsersChips');
            chipsContainer.innerHTML = '';
            
            selectedUsers.forEach(user => {
                const chip = document.createElement('div');
                chip.className = 'user-chip';
                chip.innerHTML = `
                    ${user}
                    <span class="remove-chip" onclick="removeUserSelection('${user}')">
                        <i class="fas fa-times"></i>
                    </span>
                `;
                chipsContainer.appendChild(chip);
            });
        }

        function removeUserSelection(user) {
            selectedUsers.delete(user);
            updateSelectedUsersDisplay();
            updateDropdownSelection();
        }

        function updateDropdownSelection() {
            const dropdownItems = document.querySelectorAll('.user-dropdown-item:not(.select-all-item)');
            dropdownItems.forEach(item => {
                const userName = item.textContent.trim();
                const icon = item.querySelector('i');
                if (selectedUsers.has(userName)) {
                    item.classList.add('selected');
                    icon.className = 'fas fa-check-circle';
                } else {
                    item.classList.remove('selected');
                    icon.className = 'fas fa-user';
                }
            });
        }

        function resetUserSelector() {
            selectedUsers.clear();
            document.getElementById('userSearchInput').value = '';
            updateSelectedUsersDisplay();
            hideUserDropdown();
        }

        function generateReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const selectedUsersArray = Array.from(selectedUsers);

            if (!startDate || !endDate) {
                alert('Please select both start and end dates.');
                return;
            }

            if (selectedUsersArray.length === 0) {
                alert('Please select at least one user.');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date cannot be after end date.');
                return;
            }

            const generateBtn = document.getElementById('generateReportBtn');
            const originalBtnText = generateBtn.innerHTML;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            generateBtn.disabled = true;
            
            const filteredClaims = allClaims.filter(claim => {
                if (claim.eventStatus !== 'Approved') return false;
                if (!selectedUsersArray.includes(claim.personOfSubmission)) return false;

                const claimDate = new Date(claim.createdDate);
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);

                return claimDate >= start && claimDate <= end;
            });

            reportData = generateReportData(filteredClaims, selectedUsersArray, startDate, endDate);
            
            displayReport(reportData);
            
            generateBtn.innerHTML = originalBtnText;
            generateBtn.disabled = false;
            
            document.getElementById('reportResults').style.display = 'block';
        }

        function generateReportData(claims, selectedUsers, startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);

            const reportData = {
                dateRange: { start: startDate, end: endDate },
                users: []
            };

            selectedUsers.forEach(user => {
                const userClaims = claims.filter(claim => {
                    const claimDate = new Date(claim.createdDate);
                    return (
                        claim.personOfSubmission === user &&
                        claimDate >= start &&
                        claimDate <= end
                    );
                });

                const userData = {
                    name: user,
                    totalApplications: userClaims.length,
                    totalAmount: 0,
                    stayClaimsTotal: 0,
                    mealAllowanceTotal: 0,
                    otherAllowanceTotal: 0,
                    extraClaimsTotal: 0,
                    extraClaimsCount: 0,
                    locationStats: {},
                    totalWorkingTime: { hours: 0, minutes: 0 },
                    breakdown: {
                        stayClaims: [],
                        mealAllowances: [],
                        otherAllowances: [],
                        extraClaims: []
                    }
                };

                userClaims.forEach(claim => {
                    userData.totalAmount += parseFloat(claim.totalClaim || 0);

                    const location = claim.locationStatus || 'Unknown';
                    userData.locationStats[location] = (userData.locationStats[location] || 0) + 1;

                    if (claim.totalTimeOnDuty && claim.totalTimeOnDuty.hours !== undefined) {
                        userData.totalWorkingTime.hours += parseInt(claim.totalTimeOnDuty.hours || 0);
                        userData.totalWorkingTime.minutes += parseInt(claim.totalTimeOnDuty.minutes || 0);
                    }

                    if (claim.stays && claim.stays.length > 0) {
                        claim.stays.forEach(stay => {
                            const amount = parseFloat(stay.stayCost || 0);
                            userData.stayClaimsTotal += amount;
                            userData.breakdown.stayClaims.push({
                                type: stay.stayType,
                                amount: amount,
                                applicationNumber: claim.applicationNumber
                            });
                        });
                    }

                    const mealAmount = extractAllowanceAmount(claim.mealAllowance);
                    if (mealAmount > 0) {
                        userData.mealAllowanceTotal += mealAmount;
                        userData.breakdown.mealAllowances.push({
                            amount: mealAmount,
                            applicationNumber: claim.applicationNumber
                        });
                    }

                    const otherAmount = extractAllowanceAmount(claim.otherAllowances);
                    if (otherAmount > 0) {
                        userData.otherAllowanceTotal += otherAmount;
                        userData.breakdown.otherAllowances.push({
                            amount: otherAmount,
                            applicationNumber: claim.applicationNumber
                        });
                    }

                    if (claim.extraClaims && claim.extraClaims.length > 0) {
                        claim.extraClaims.forEach(extra => {
                            const amount = parseFloat(extra.claimAmount || 0);
                            userData.extraClaimsTotal += amount;
                            userData.extraClaimsCount++;
                            userData.breakdown.extraClaims.push({
                                description: extra.claimDescription,
                                amount: amount,
                                applicationNumber: claim.applicationNumber
                            });
                        });
                    }
                });

                userData.totalWorkingTime.hours += Math.floor(userData.totalWorkingTime.minutes / 60);
                userData.totalWorkingTime.minutes = userData.totalWorkingTime.minutes % 60;

                reportData.users.push(userData);
            });

            return reportData;
        }

        function extractAllowanceAmount(allowanceData) {
            if (!allowanceData) return 0;

            let parsedData;
            
            if (typeof allowanceData === 'object' && allowanceData.label) {
                try {
                    parsedData = JSON.parse(allowanceData.label);
                } catch (e) {
                    return 0;
                }
            } else if (typeof allowanceData === 'string') {
                try {
                    parsedData = JSON.parse(allowanceData);
                } catch (e) {
                    return 0;
                }
            } else if (typeof allowanceData === 'object') {
                parsedData = allowanceData;
            } else {
                return 0;
            }

            return parseFloat(parsedData.totalAmount || parsedData.amount || 0);
        }

        function displayReport(data) {
            const container = document.getElementById('reportContent');
            let html = '';

            if (data.users.length === 0) {
                html = `
                    <div class="no-report-data">
                        <i class="fas fa-chart-line"></i>
                        No approved claims found for the selected criteria.
                    </div>
                `;
            } else {
                data.users.forEach(user => {
                    html += generateUserReportHTML(user);
                });
            }

            container.innerHTML = html;
        }

        function generateUserReportHTML(user) {
            const formatTime = (hours, minutes) => {
                return `${hours}h ${minutes}m`;
            };

            let html = `
                <div class="user-report">
                    <div class="user-report-header">
                        <i class="fas fa-user"></i>${user.name}
                    </div>
                    <div class="user-report-content">
                        <div class="summary-grid">
                            <div class="summary-card">
                                <i class="fas fa-file-alt"></i>
                                <div class="value">${user.totalApplications}</div>
                                <div class="label">Total Applications</div>
                            </div>
                            <div class="summary-card">
                                <i class="fas fa-money-bill-wave"></i>
                                <div class="value">RM ${formatCurrency(user.totalAmount)}</div>
                                <div class="label">Total Claims</div>
                            </div>
                            <div class="summary-card">
                                <i class="fas fa-clock"></i>
                                <div class="value">${formatTime(user.totalWorkingTime.hours, user.totalWorkingTime.minutes)}</div>
                                <div class="label">Total Working Time</div>
                            </div>
                            <div class="summary-card">
                                <i class="fas fa-plus-circle"></i>
                                <div class="value">${user.extraClaimsCount}</div>
                                <div class="label">Extra Claims Count</div>
                            </div>
                        </div>

                        <div class="breakdown-section">
                            <div class="breakdown-title">
                                <i class="fas fa-chart-pie"></i>Claims Breakdown
                            </div>
                            <div class="breakdown-grid">
                                <div class="breakdown-item">
                                    <div class="amount">RM ${formatCurrency(user.stayClaimsTotal)}</div>
                                    <div class="type">Stay Claims</div>
                                </div>
                                <div class="breakdown-item">
                                    <div class="amount">RM ${formatCurrency(user.mealAllowanceTotal)}</div>
                                    <div class="type">Meal Allowances</div>
                                </div>
                                <div class="breakdown-item">
                                    <div class="amount">RM ${formatCurrency(user.otherAllowanceTotal)}</div>
                                    <div class="type">Other Allowances</div>
                                </div>
                                <div class="breakdown-item">
                                    <div class="amount">RM ${formatCurrency(user.extraClaimsTotal)}</div>
                                    <div class="type">Extra Claims</div>
                                </div>
                            </div>
                        </div>

                        <div class="breakdown-section">
                            <div class="breakdown-title">
                                <i class="fas fa-map-marker-alt"></i>Location Statistics
                            </div>
                            <div class="location-stats">
            `;

            Object.entries(user.locationStats).forEach(([location, count]) => {
                html += `
                    <div class="location-stat">
                        <div class="count">${count}</div>
                        <div class="location">${location}</div>
                    </div>
                `;
            });

            html += `
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return html;
        }

        function exportReportPDF() {
            if (!reportData || !reportData.users || reportData.users.length === 0) {
                alert('No report data to export.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait' });

            const primaryColor = [45, 12, 49];
            const accentColor = [0, 184, 148];
            const lightGray = [245, 245, 245];
            const white = [255, 255, 255];
            const black = [0, 0, 0];
            const tagColor = [220, 220, 220];

            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 20, 'F');
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...white);
            doc.text('USER CLAIM & ALLOWANCE REPORT', 15, 13);

            const dateRange = `Report Date Range: ${reportData.dateRange.start} to ${reportData.dateRange.end}`;
            doc.setFillColor(...accentColor);
            doc.rect(0, 22, 210, 8, 'F');
            doc.setFontSize(12);
            doc.setTextColor(...white);
            doc.text(dateRange, 15, 28);

            doc.setTextColor(...black);

            let y = 40;
            reportData.users.forEach(user => {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }

                doc.setFillColor(...lightGray);
                doc.roundedRect(10, y, 190, 65, 4, 4, 'F');

                doc.setFillColor(...accentColor);
                doc.roundedRect(10, y, 190, 10, 4, 4, 'F');
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...white);
                doc.text(user.name, 15, y + 7);

                doc.setTextColor(...black);
                doc.setFontSize(10);

                let detailY = y + 16;
                doc.text(`Total Applications: ${user.totalApplications}`, 15, detailY);
                doc.text(`Total Amount (RM): ${user.totalAmount.toFixed(2)}`, 115, detailY);

                detailY += 8;
                doc.text(`Stay Claims (RM): ${user.stayClaimsTotal.toFixed(2)}`, 15, detailY);
                doc.text(`Meal Allowances (RM): ${user.mealAllowanceTotal.toFixed(2)}`, 115, detailY);

                detailY += 8;
                doc.text(`Other Allowances (RM): ${user.otherAllowanceTotal.toFixed(2)}`, 15, detailY);
                doc.text(`Extra Claims (RM): ${user.extraClaimsTotal.toFixed(2)}`, 115, detailY);

                detailY += 8;
                doc.text(`Extra Claims Count: ${user.extraClaimsCount}`, 15, detailY);
                doc.text(`Total Time: ${user.totalWorkingTime.hours}h ${user.totalWorkingTime.minutes}m`, 115, detailY);

                detailY += 10;
                doc.setFontSize(9);
                let tagX = 15;
                Object.entries(user.locationStats).forEach(([loc, count]) => {
                    const tagText = `${loc}: ${count}`;
                    const textWidth = doc.getTextWidth(tagText) + 6;
                    doc.setFillColor(...tagColor);
                    doc.roundedRect(tagX, detailY - 5, textWidth, 6, 2, 2, 'F');
                    doc.text(tagText, tagX + 3, detailY - 1);
                    tagX += textWidth + 4;
                });

                y += 75;
            });

            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFillColor(...primaryColor);
                doc.rect(0, 285, 210, 12, 'F');

                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(...white);
                doc.text('Generated by Staff Claim and Allowance System', 15, 292);
                doc.text(`Page ${i} of ${pageCount}`, 180, 292);
                doc.text(new Date().toLocaleDateString(), 15, 296);
            }

            const fileName = `claims_report_${reportData.dateRange.start}_to_${reportData.dateRange.end}.pdf`;
            doc.save(fileName);
        }

        window.onclick = function(event) {
            const claimModal = document.getElementById('claimModal');
            const reportModal = document.getElementById('reportModal');
            
            if (event.target === claimModal) {
                closeModal();
            }
            if (event.target === reportModal) {
                closeReportModal();
            }
        }
    </script>
</body>
</html>
